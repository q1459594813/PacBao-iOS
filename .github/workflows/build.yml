name: Build IPA (Final Fix)

on:
  workflow_dispatch: # 手动触发

env:
  APP_NAME: "SillyTavern"
  BUNDLE_ID: "com.tavern.ios"
  # 你的酒馆地址 (请确认这是你的 Tailscale 地址)
  TARGET_URL: "http://100.86.55.29:8000"
  VERSION: "1.0.0"

jobs:
  build:
    runs-on: macos-14 # 依然用最稳的 Xcode 15 环境
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.4'

      - name: Install Tools
        run: brew install xcodegen

      # 1. 清理环境
      - name: Prepare Clean Workspace
        run: |
          rm -rf *
          mkdir -p App/Sources
          mkdir -p App/Resources

      # 2. 生成图标
      - name: Generate Icon
        run: |
          echo "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8z8BQDwAEhQGAhKmMIQAAAABJRU5ErkJggg==" | base64 -d > App/Resources/AppIcon.png
          sips -z 1024 1024 App/Resources/AppIcon.png --out App/Resources/Icon1024.png

      # 3. 写入 Swift 代码 (你的酒馆逻辑)
      - name: Write Swift Code
        run: |
          # 写入入口
          cat > App/Sources/SillyTavernApp.swift <<EOF
          import SwiftUI
          @main
          struct SillyTavernApp: App {
              var body: some Scene {
                  WindowGroup {
                      ContentView()
                  }
              }
          }
          EOF

          # 写入网页容器 (带全屏补丁)
          cat > App/Sources/ContentView.swift <<EOF
          import SwiftUI
          import WebKit

          struct ContentView: View {
              var body: some View {
                  WebView(url: URL(string: "${{ env.TARGET_URL }}")!)
                      .edgesIgnoringSafeArea(.all)
                      .statusBar(hidden: true)
              }
          }

          struct WebView: UIViewRepresentable {
              let url: URL
              func makeUIView(context: Context) -> WKWebView {
                  let config = WKWebViewConfiguration()
                  config.allowsInlineMediaPlayback = true
                  if #available(iOS 15.4, *) {
                      config.setValue(true, forKey: "allowsElementPresentingFullscreen")
                  }
                  let webView = WKWebView(frame: .zero, configuration: config)
                  webView.scrollView.bounces = false
                  // 注入全屏 JS
                  let script = """
                  var meta = document.createElement('meta');
                  meta.name = 'viewport';
                  meta.content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no';
                  document.head.appendChild(meta);
                  if (document.documentElement.webkitRequestFullscreen) {
                      document.documentElement.requestFullscreen = document.documentElement.webkitRequestFullscreen;
                      Element.prototype.requestFullscreen = Element.prototype.webkitRequestFullscreen || Element.prototype.webkitEnterFullscreen;
                  }
                  """
                  let userScript = WKUserScript(source: script, injectionTime: .atDocumentEnd, forMainFrameOnly: false)
                  webView.configuration.userContentController.addUserScript(userScript)
                  webView.load(URLRequest(url: url))
                  return webView
              }
              func updateUIView(_ uiView: WKWebView, context: Context) {}
          }
          EOF

      # 4. 生成项目文件 (★关键修复点★)
      - name: Generate Project File
        run: |
          cat > project.yml <<EOF
          name: ${{ env.APP_NAME }}
          options:
            bundleIdPrefix: ${{ env.BUNDLE_ID }}
            deploymentTarget:
              iOS: "16.0"
            # ⭐️ 核心修复：强制使用旧版项目格式 (54)，让 Xcode 15 能打开
            objectVersion: 54
          targets:
            ${{ env.APP_NAME }}:
              type: application
              platform: iOS
              sources: [App/Sources]
              settings:
                PRODUCT_BUNDLE_IDENTIFIER: ${{ env.BUNDLE_ID }}
                INFOPLIST_FILE: Info.plist
                IPHONEOS_DEPLOYMENT_TARGET: "16.0"
                CODE_SIGN_IDENTITY: ""
                CODE_SIGNING_REQUIRED: "NO"
                CODE_SIGNING_ALLOWED: "NO"
                CURRENT_PROJECT_VERSION: 1
                MARKETING_VERSION: ${{ env.VERSION }}
                ASSETCATALOG_COMPILER_APPICON_NAME: AppIcon
              info:
                path: Info.plist
                properties:
                  NSAppTransportSecurity:
                    NSAllowsArbitraryLoads: true
                  UIStatusBarHidden: true
                  UIViewControllerBasedStatusBarAppearance: false
                  UISupportedInterfaceOrientations: [UIInterfaceOrientationPortrait, UIInterfaceOrientationLandscapeLeft, UIInterfaceOrientationLandscapeRight]
          EOF
          
          # 整理图标
          mkdir -p App/Sources/Assets.xcassets/AppIcon.appiconset
          mv App/Resources/Icon1024.png App/Sources/Assets.xcassets/AppIcon.appiconset/1024.png
          echo '{"images":[{"size":"1024x1024","idiom":"ios-marketing","filename":"1024.png","scale":"1x"},{"size":"1024x1024","idiom":"universal","platform":"ios","filename":"1024.png"}],"info":{"version":1,"author":"xcode"}}' > App/Sources/Assets.xcassets/AppIcon.appiconset/Contents.json

          # 执行生成
          xcodegen generate

      # 5. 打包 (Archive)
      - name: Archive
        run: |
          xcodebuild archive \
            -project "${{ env.APP_NAME }}.xcodeproj" \
            -scheme "${{ env.APP_NAME }}" \
            -configuration Release \
            -sdk iphoneos \
            -archivePath "./build/${{ env.APP_NAME }}.xcarchive" \
            -destination 'generic/platform=iOS' \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            AD_HOC_CODE_SIGNING_ALLOWED=YES

      # 6. 导出 IPA
      - name: Export IPA
        run: |
          mkdir -p Payload
          APP_PATH=$(find ./build/${{ env.APP_NAME }}.xcarchive -name "*.app" -type d | head -n 1)
          cp -r "$APP_PATH" Payload/
          zip -r "${{ env.APP_NAME }}.ipa" Payload

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SillyTavern-IPA
          path: "*.ipa"

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          files: "*.ipa"
          tag_name: 'v${{ env.VERSION }}'
          name: '${{ env.APP_NAME }} v${{ env.VERSION }}'
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
