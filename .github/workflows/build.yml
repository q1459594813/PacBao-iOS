name: Build IPA

on:
  workflow_dispatch: # 手动触发

env:
  NAME: "SillyTavern"
  VERSION: "1.0.0"

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.2.0'

      # ⭐️ 核心修复：创建文件夹并清理项目残留
      - name: Prepare Workspace
        run: |
          mkdir -p "./PakePlus/Preview Content"
          # 彻底清除可能导致报错的缓存
          rm -rf build/
          
      - uses: pnpm/action-setup@v3
        with:
          version: latest

      - name: Sync node version and setup cache
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Init Project Config
        run: |
          pnpm install
          pnpm pp:worker

      # ⭐️ 核心步骤：改用 xcodebuild archive 模式
      - name: Archive with Xcode
        run: |
          PROJECT_NAME=$(ls -d *.xcodeproj | head -n 1)
          SCHEME_NAME=$(basename "$PROJECT_NAME" .xcodeproj)
          
          echo "Archiving $SCHEME_NAME..."
          
          xcodebuild archive \
            -project "$PROJECT_NAME" \
            -scheme "$SCHEME_NAME" \
            -configuration Release \
            -sdk iphoneos \
            -archivePath "./build/${{ env.NAME }}.xcarchive" \
            -destination 'generic/platform=iOS' \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            AD_HOC_CODE_SIGNING_ALLOWED=YES \
            COMPILER_INDEX_STORE_ENABLE=NO \
            ASSETCATALOG_COMPILER_SKIP_APP_STORE_UTILIZATION=YES \
            VALIDATE_WORKSPACE=NO

      # ⭐️ 核心步骤：从归档中提取 .app 并打包 IPA
      - name: Export App and Package IPA
        run: |
          mkdir -p Payload
          # 从 .xcarchive 文件夹中提取真正的 App 文件
          APP_PATH=$(find ./build/${{ env.NAME }}.xcarchive -name "*.app" -type d | head -n 1)
          echo "Found App at: $APP_PATH"
          cp -r "$APP_PATH" Payload/
          zip -r "${{ env.NAME }}-${{ env.VERSION }}.ipa" Payload
          echo "ipa_path=${{ env.NAME }}-${{ env.VERSION }}.ipa" >> $GITHUB_ENV

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SillyTavern-Success-IPA
          path: "*.ipa"

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          files: "*.ipa"
          tag_name: 'v${{ env.VERSION }}'
          name: '${{ env.NAME }} v${{ env.VERSION }}'
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
