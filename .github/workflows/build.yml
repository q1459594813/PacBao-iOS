name: Build IPA

on:
  workflow_dispatch: # 手动触发

env:
  NAME: "SillyTavern"
  VERSION: "1.0.0"
  BUNDLE_ID: "com.tavern.ios"

jobs:
  build:
    runs-on: macos-14 # 使用稳定的 Xcode 15 环境
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.4'

      - uses: pnpm/action-setup@v3
        with:
          version: latest

      - name: Sync node version and setup cache
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Init Project Config
        run: |
          pnpm install
          pnpm pp:worker

      # ⭐️ 核心步骤 1：安装 XcodeGen 工具
      - name: Install XcodeGen
        run: brew install xcodegen

      # ⭐️ 核心步骤 2：生成缺失的图标 (防止新项目缺资源)
      - name: Fix Assets & Icons
        run: |
          echo "Generating missing AppIcons..."
          mkdir -p "./PakePlus/Preview Content"
          ASSETS_PATH="./PakePlus/Assets.xcassets/AppIcon.appiconset"
          
          # 生成临时图标
          if [ ! -f "app-icon.png" ]; then
             echo "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8z8BQDwAEhQGAhKmMIQAAAABJRU5ErkJggg==" | base64 -d > app-icon.png
          fi
          
          # 处理图标
          if [ -f "app-icon.png" ]; then
            sips -z 1024 1024 app-icon.png --out "$ASSETS_PATH/1024.png"
            echo '{"images":[{"size":"1024x1024","idiom":"ios-marketing","filename":"1024.png","scale":"1x"},{"size":"1024x1024","idiom":"universal","platform":"ios","filename":"1024.png"}],"info":{"version":1,"author":"xcode"}}' > "$ASSETS_PATH/Contents.json"
          fi

      # ⭐️ 核心步骤 3：定义新项目结构 (这是重建的蓝图)
      - name: Create Project Definition
        run: |
          # 删掉那个坏掉的旧项目文件
          rm -rf *.xcodeproj
          
          # 写入 XcodeGen 配置文件
          cat > project.yml <<EOF
          name: PakePlus
          options:
            bundleIdPrefix: com.tavern
            deploymentTarget:
              iOS: "16.0"
          targets:
            PakePlus:
              type: application
              platform: iOS
              deploymentTarget: "16.0"
              sources: [PakePlus]
              settings:
                PRODUCT_BUNDLE_IDENTIFIER: ${{ env.BUNDLE_ID }}
                INFOPLIST_FILE: PakePlus/Info.plist
                IPHONEOS_DEPLOYMENT_TARGET: "16.0"
                CODE_SIGN_IDENTITY: ""
                CODE_SIGNING_REQUIRED: "NO"
                CODE_SIGNING_ALLOWED: "NO"
                MARKETING_VERSION: ${{ env.VERSION }}
                CURRENT_PROJECT_VERSION: 1
              info:
                path: PakePlus/Info.plist
                properties:
                  NSAppTransportSecurity:
                    NSAllowsArbitraryLoads: true
                  UIStatusBarHidden: true
                  UIViewControllerBasedStatusBarAppearance: false
          EOF

      # ⭐️ 核心步骤 4：执行重建
      - name: Generate New Project
        run: xcodegen generate

      # ⭐️ 核心步骤 5：打包新项目
      - name: Archive with Xcode
        run: |
          # 此时 PakePlus.xcodeproj 已经是全新的了
          xcodebuild archive \
            -project "PakePlus.xcodeproj" \
            -scheme "PakePlus" \
            -configuration Release \
            -sdk iphoneos \
            -archivePath "./build/${{ env.NAME }}.xcarchive" \
            -destination 'generic/platform=iOS' \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            AD_HOC_CODE_SIGNING_ALLOWED=YES

      - name: Export App and Package IPA
        run: |
          mkdir -p Payload
          APP_PATH=$(find ./build/${{ env.NAME }}.xcarchive -name "*.app" -type d | head -n 1)
          echo "Found App at: $APP_PATH"
          
          cp -r "$APP_PATH" Payload/
          zip -r "${{ env.NAME }}-${{ env.VERSION }}.ipa" Payload
          echo "ipa_path=${{ env.NAME }}-${{ env.VERSION }}.ipa" >> $GITHUB_ENV

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SillyTavern-IPA
          path: "*.ipa"

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          files: "*.ipa"
          tag_name: 'v${{ env.VERSION }}'
          name: '${{ env.NAME }} v${{ env.VERSION }}'
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
