name: Build IPA

on:
  workflow_dispatch: # 手动触发

env:
  NAME: "SillyTavern"
  VERSION: "1.0.0"

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.2.0'

      # ⭐️ 第一步：彻底修复并清理可能导致报错的图标文件
      - name: Fix Assets and Icons
        run: |
          echo "Cleaning up problematic asset files..."
          # 如果图标文件夹有问题，我们直接强行重置它的配置文件
          find ./ -name "Contents.json" -exec chmod 644 {} \;
          # 确保所有的 PNG 文件都是可读的
          find ./ -name "*.png" -exec chmod 644 {} \;

      - uses: pnpm/action-setup@v3
        with:
          version: latest

      - name: Sync node version and setup cache
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Init Project Config
        run: |
          pnpm install
          pnpm pp:worker

      # ⭐️ 第二步：改用原生的 xcodebuild 编译（绕过 Theos 的错误）
      - name: Build with Xcode
        run: |
          # 找到项目文件名
          PROJECT_NAME=$(ls -d *.xcodeproj | head -n 1)
          SCHEME_NAME=$(basename "$PROJECT_NAME" .xcodeproj)
          
          echo "Building $SCHEME_NAME..."
          
          # 直接编译成 .app 文件
          xcodebuild -project "$PROJECT_NAME" \
                     -scheme "$SCHEME_NAME" \
                     -configuration Release \
                     -sdk iphoneos \
                     -derivedDataPath ./build \
                     clean build \
                     CODE_SIGNING_ALLOWED=NO \
                     CODE_SIGNING_REQUIRED=NO

      # ⭐️ 第三步：手动封装成 IPA
      - name: Package IPA
        run: |
          mkdir -p Payload
          # 找到刚才生成的 .app 文件夹并放入 Payload
          APP_PATH=$(find ./build -name "*.app" -type d | head -n 1)
          cp -r "$APP_PATH" Payload/
          # 压缩成 IPA
          zip -r "${{ env.NAME }}-${{ env.VERSION }}.ipa" Payload
          echo "ipa_path=${{ env.NAME }}-${{ env.VERSION }}.ipa" >> $GITHUB_ENV

      # ⭐️ 第四步：上传到 Artifacts (方便你直接下载，不用去 Release 找)
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.NAME }}-IPA-File
          path: ${{ env.ipa_path }}

      # 同时也发一份到 Releases
      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ env.ipa_path }}
          tag_name: 'v${{ env.VERSION }}'
          name: '${{ env.NAME }} v${{ env.VERSION }}'
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
