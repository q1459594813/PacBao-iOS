name: Build IPA

on:
  workflow_dispatch: # 手动触发编译

# 这里帮你定义好应用的名字和版本，防止重命名失败
env:
  NAME: "SillyTavern"
  VERSION: "1.0.0"
  PUBBODY: "基于 PakePlus 封装的酒馆 iOS 版，支持全屏补丁。"

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.2.0'

      - name: Install Dependencies (Homebrew & Theos)
        run: |
          echo "Installing Homebrew..."
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

          echo "Setting up Homebrew..."
          echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> $HOME/.zprofile
          eval "$(/opt/homebrew/bin/brew shellenv)"

          echo "Installing Theos dependencies..."
          brew install ldid dpkg

          echo "Cloning Theos..."
          git clone --recursive https://github.com/theos/theos.git $HOME/theos
          echo 'export THEOS=$HOME/theos' >> $HOME/.zshrc
          export THEOS=$HOME/theos

      - uses: pnpm/action-setup@v3
        with:
          version: latest

      - name: Sync node version and setup cache
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Init Project Config
        run: |
          pnpm install
          pnpm pp:worker

      # ⭐️ 星星提示：这里已经删除了报错的 Generate AppIcon 步骤，直接使用你现有的图标

      - name: Build IPA Package
        run: |
          export THEOS=$HOME/theos
          echo "Building IPA package..."
          make package FINALPACKAGE=1 PACKAGE_FORMAT=ipa

      - name: Get IPA File Path
        id: find_ipa
        run: |
          # 寻找生成的 ipa 文件
          IPA_PATH=$(find ./packages -name "*.ipa" | head -n 1)
          echo "IPA File: $IPA_PATH"
          echo "ipa_path=$IPA_PATH" >> $GITHUB_ENV

      - name: Rename IPA File
        run: |
          # 使用上面定义的 NAME 和 VERSION 进行重命名
          NAME="${{ env.NAME }}"
          VERSION="${{ env.VERSION }}"
          IPA_PATH="${{ env.ipa_path }}"
          DIR=$(dirname "$IPA_PATH")
          NEW_NAME="${NAME}-${VERSION}.ipa"
          NEW_PATH="${DIR}/${NEW_NAME}"
          mv "$IPA_PATH" "$NEW_PATH"
          echo "Renamed IPA: $NEW_PATH"
          echo "ipa_path=$NEW_PATH" >> $GITHUB_ENV
          ls -l $DIR

      - name: Upload IPA to GitHub Releases
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ env.ipa_path }}
          tag_name: 'v${{ env.VERSION }}'
          name: '${{ env.NAME }} v${{ env.VERSION }}'
          body: '${{ env.PUBBODY }}'
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
